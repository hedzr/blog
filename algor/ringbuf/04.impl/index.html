


<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="by hedzr, not blog">
      
      
        <link rel="canonical" href="https://hedzr.github.io/blog/algor/ringbuf/04.impl/">
      
      
        <meta name="author" content="Hedzr Studio Authors">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.0">
    
    
      
        <title>Golang ç¯å½¢é˜Ÿåˆ—å®ç° - Hedzr's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.89dc9fe3.min.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecd4686e.min.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,400i,700%7CFira+Mono&display=fallback">
        <style>body,input{font-family:"Titillium Web",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
      <link rel="manifest" href="../../../manifest.webmanifest" crossorigin="use-credentials">
    
    
      <link rel="stylesheet" href="../../../statics/css/extra.css?v=17">
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-171624977-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    <body dir="" data-md-color-primary="blue-grey" data-md-color-accent="brown">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#golang" class="md-skip">
          è·³è½¬è‡³
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="">
    <a href="https://hedzr.github.io/blog" title="Hedzr's Blog" class="md-header-nav__button md-logo" aria-label="Hedzr's Blog">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Hedzr's Blog
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Golang ç¯å½¢é˜Ÿåˆ—å®ç°
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="æœç´¢" placeholder="æœç´¢" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            é”®å…¥ä»¥å¼€å§‹æœç´¢
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://hedzr.github.io/blog/" title="å‰å¾€ GitHub ä»“åº“" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hedzr/blog
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../" class="md-tabs__link md-tabs__link--active">
          Algorithm
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../about/" class="md-tabs__link">
          About
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../../tests/test1/" class="md-tabs__link">
          Tests
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://hedzr.github.io/blog" title="Hedzr's Blog" class="md-nav__button md-logo" aria-label="Hedzr's Blog">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8M12,11.54C9.64,9.35 6.5,8 3,8V19C6.5,19 9.64,20.35 12,22.54C14.36,20.35 17.5,19 21,19V8C17.5,8 14.36,9.35 12,11.54Z" /></svg>

    </a>
    Hedzr's Blog
  </label>
  
    <div class="md-nav__source">
      
<a href="https://hedzr.github.io/blog/" title="å‰å¾€ GitHub ä»“åº“" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    hedzr/blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Algorithm
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Algorithm" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Algorithm
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
    
    <label class="md-nav__link" for="nav-2-2">
      Ring Buffer
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Ring Buffer" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Ring Buffer
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01.intro/" title="RingBuf ç®€ä»‹" class="md-nav__link">
      RingBuf ç®€ä»‹
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02.lock-free/" title="æ— é”ç¼–ç¨‹æ¦‚è¦" class="md-nav__link">
      æ— é”ç¼–ç¨‹æ¦‚è¦
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03.smp/" title="å¹¶å‘ç¼–ç¨‹å’Œå¤šæ ¸ç¼–ç¨‹æ¦‚è¦" class="md-nav__link">
      å¹¶å‘ç¼–ç¨‹å’Œå¤šæ ¸ç¼–ç¨‹æ¦‚è¦
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Golang ç¯å½¢é˜Ÿåˆ—å®ç°
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,9H17V7H3V9M3,13H17V11H3V13M3,17H17V15H3V17M19,17H21V15H19V17M19,7V9H21V7H19M19,13H21V11H19V13Z" /></svg>
        </span>
      </label>
    
    <a href="./" title="Golang ç¯å½¢é˜Ÿåˆ—å®ç°" class="md-nav__link md-nav__link--active">
      Golang ç¯å½¢é˜Ÿåˆ—å®ç°
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    åŸºæœ¬å®šä¹‰
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    æ“ä½œ
  </a>
  
    <nav class="md-nav" aria-label="æ“ä½œ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    æµ‹è¯•ï¼šé˜Ÿåˆ—ç©ºï¼Œé˜Ÿåˆ—æ»¡
  </a>
  
    <nav class="md-nav" aria-label="æµ‹è¯•ï¼šé˜Ÿåˆ—ç©ºï¼Œé˜Ÿåˆ—æ»¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headtail" class="md-nav__link">
    å…³äº head/tail çš„è½½å…¥ä¼˜åŒ–
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#headtail_1" class="md-nav__link">
    è¿›ä¸€æ­¥çš„é’ˆå¯¹ head/tail çš„ä¼˜åŒ–
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    å…³äºåˆ¤å®šç®—æ³•
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cap-size" class="md-nav__link">
    Cap å’Œ Size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enqueue-put" class="md-nav__link">
    Enqueue / Put
  </a>
  
    <nav class="md-nav" aria-label="Enqueue / Put">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#put" class="md-nav__link">
    Put ç®—æ³•
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    ä¾‹å¤–æƒ…å†µ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dequeue-get" class="md-nav__link">
    Dequeue / Get
  </a>
  
    <nav class="md-nav" aria-label="Dequeue / Get">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    Getç®—æ³•
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    å°ç»“
  </a>
  
    <nav class="md-nav" aria-label="å°ç»“">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    æ€§èƒ½
  </a>
  
    <nav class="md-nav" aria-label="æ€§èƒ½">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpmc" class="md-nav__link">
    MPMC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    å¯¹ç…§
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    è¯´æ˜
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    ğŸ”š
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      About
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="About" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/htc/" title="Contrib" class="md-nav__link">
      Contrib
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/cc4/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Tests
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tests" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
        </span>
        Tests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tests/test1/" title="Test1" class="md-nav__link">
      Test1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tests/test2/" title="Test2" class="md-nav__link">
      Test2
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="ç›®å½•">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
      </span>
      ç›®å½•
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    åŸºæœ¬å®šä¹‰
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    æ“ä½œ
  </a>
  
    <nav class="md-nav" aria-label="æ“ä½œ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    æµ‹è¯•ï¼šé˜Ÿåˆ—ç©ºï¼Œé˜Ÿåˆ—æ»¡
  </a>
  
    <nav class="md-nav" aria-label="æµ‹è¯•ï¼šé˜Ÿåˆ—ç©ºï¼Œé˜Ÿåˆ—æ»¡">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#headtail" class="md-nav__link">
    å…³äº head/tail çš„è½½å…¥ä¼˜åŒ–
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#headtail_1" class="md-nav__link">
    è¿›ä¸€æ­¥çš„é’ˆå¯¹ head/tail çš„ä¼˜åŒ–
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    å…³äºåˆ¤å®šç®—æ³•
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cap-size" class="md-nav__link">
    Cap å’Œ Size
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enqueue-put" class="md-nav__link">
    Enqueue / Put
  </a>
  
    <nav class="md-nav" aria-label="Enqueue / Put">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#put" class="md-nav__link">
    Put ç®—æ³•
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    ä¾‹å¤–æƒ…å†µ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dequeue-get" class="md-nav__link">
    Dequeue / Get
  </a>
  
    <nav class="md-nav" aria-label="Dequeue / Get">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get" class="md-nav__link">
    Getç®—æ³•
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    å°ç»“
  </a>
  
    <nav class="md-nav" aria-label="å°ç»“">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    æ€§èƒ½
  </a>
  
    <nav class="md-nav" aria-label="æ€§èƒ½">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mpmc" class="md-nav__link">
    MPMC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    å¯¹ç…§
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    è¯´æ˜
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    ğŸ”š
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://hedzr.github.io/blog/pre-edit/?ref=/algor/ringbuf/04.impl.md" title="ç¼–è¾‘æ­¤é¡µ" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>
                  </a>
                
                
                  
                
                
                <h1 id="golang">Golangç‰ˆæœ¬ç¯å½¢é˜Ÿåˆ—å®ç°<a class="headerlink" href="#golang" title="Permanent link">&para;</a></h1>
<p><a href="https://github.com/hedzr/go-ringbuf">https://github.com/hedzr/go-ringbuf</a></p>
<p>ä¸‹é¢å°†ä¾æ®å‰é¢çš„èƒŒæ™¯çŸ¥è¯†å®ç°ä¸€ä¸ªæ— é”çš„ç¯å½¢é˜Ÿåˆ—ï¼ˆCircular Queueï¼ŒRing Bufferï¼‰ï¼Œå°½å¯èƒ½åœ°è§£é™¤å„ç§ç«äº‰çŠ¶å†µã€‚</p>
<h3 id="_1">åŸºæœ¬å®šä¹‰<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>é¦–å…ˆæ˜¯é˜Ÿåˆ—çš„å¤§å°ï¼Œå¤šæ•°å·²æœ‰çš„ç¯å½¢é˜Ÿåˆ—å‡æ¨èä½¿ç”¨ 2 çš„å†¥æ•°ï¼ˆ<code>2^n</code>ï¼‰ä¸ºé˜Ÿåˆ—å°ºå¯¸ï¼Œå…¶å¥½å¤„åœ¨äºé€šè¿‡å’Œ <code>2^n-1</code> çš„ <code>AND</code> æ“ä½œå³å¯å°† <code>head</code>/<code>tail</code> æŒ‡é’ˆç»•å›ï¼Œé¿å…äº† <code>mod</code> æ“ä½œã€‚åœ¨ CPU æŒ‡ä»¤é›†ä¸­ï¼Œ<code>mod</code> æ“ä½œä¾èµ–äºä¸€ä¸ª <code>IDIV</code> ï¼ˆæ•´æ•°é™¤æ³•ï¼‰è¿ç®—ï¼Œè¿™é€šå¸¸æ˜¯ <code>AND</code> æ“ä½œè€—æ—¶çš„æ•°å€ã€‚</p>
<p>å…¶æ¬¡æ˜¯ <code>ringbuf</code> ç»“æ„ä½“çš„å¯¹é½ï¼Œåœ¨ Golang ä¸­è¿™æ˜¯è‡ªåŠ¨çš„ï¼Œæ‰€ä»¥æ²¡æœ‰ä»€ä¹ˆå¯è¯´çš„ã€‚</p>
<p>ä¸ºäº†è§£å†³ <code>ringbuf</code> å…ƒç´ æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´  <code>rbItem</code> çš„ CacheLine é—®é¢˜ï¼Œæˆ‘ä»¬å¯¹å…¶è¿›è¡Œäº†å¡«å……ï¼Œä½¿å¾—ä¸€ä¸ª <code>rbItem</code> èƒ½å¤Ÿå æ»¡ä¸€ä¸ª CacheLineã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="p">(</span>
    <span class="nx">Queue</span> <span class="kd">interface</span> <span class="p">{</span>
        <span class="nx">Enqueue</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
        <span class="nx">Dequeue</span><span class="p">()</span> <span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
        <span class="c1">// Cap returns the outer capacity of the ring buffer.</span>
        <span class="nx">Cap</span><span class="p">()</span> <span class="kt">uint32</span>
        <span class="c1">// Size returns the quantity of items in the ring buffer queue</span>
        <span class="nx">Size</span><span class="p">()</span> <span class="kt">uint32</span>
        <span class="nx">IsEmpty</span><span class="p">()</span> <span class="p">(</span><span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span>
        <span class="nx">IsFull</span><span class="p">()</span> <span class="p">(</span><span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">RingBuffer</span> <span class="kd">interface</span> <span class="p">{</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">Closer</span> <span class="c1">// for logger</span>

        <span class="nx">Queue</span>

        <span class="nx">Put</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
        <span class="nx">Get</span><span class="p">()</span> <span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>

        <span class="c1">// Quantity returns the quantity of items in the ring buffer queue</span>
        <span class="nx">Quantity</span><span class="p">()</span> <span class="kt">uint32</span>

        <span class="nx">Debug</span><span class="p">(</span><span class="nx">enabled</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">lastState</span> <span class="kt">bool</span><span class="p">)</span>

        <span class="nx">ResetCounters</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nx">ringBuf</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">cap</span>        <span class="kt">uint32</span>
        <span class="nx">capModMask</span> <span class="kt">uint32</span>
        <span class="nx">head</span>       <span class="kt">uint32</span>
        <span class="nx">tail</span>       <span class="kt">uint32</span>
        <span class="nx">putWaits</span>   <span class="kt">uint64</span>
        <span class="nx">getWaits</span>   <span class="kt">uint64</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">data</span>       <span class="p">[]</span><span class="nx">rbItem</span>
        <span class="nx">debugMode</span>  <span class="kt">bool</span>
        <span class="nx">logger</span>     <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="p">}</span>

    <span class="nx">rbItem</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">readWrite</span> <span class="kt">uint64</span>      <span class="c1">// 0: writable, 1: readable, 2: write ok, 3: read ok</span>
        <span class="nx">value</span>     <span class="kd">interface</span><span class="p">{}</span> <span class="c1">// ptr</span>
        <span class="nx">_</span>         <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
        <span class="c1">// _         cpu.CacheLinePad</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<p>è‡³äº <code>Queue</code> å’Œ <code>RingBuffer</code> æ˜¯åº“ä½œè€…çš„ä¾‹è¡Œæ“ä½œï¼Œå°±ä¸èµ˜è¿°äº†ã€‚</p>
<p>åœ¨ <code>rbItem</code> ä¸­å¢åŠ äº† CacheLine å¯¹é½å­—æ®µï¼Œè¿™æ˜¯ä¸ºäº†é¿å…æ¯ä¸ª producer/consumer æ“ä½œä¸€ä¸ª <code>rbItem</code> æ—¶å½¼æ­¤ä¹‹é—´å‘ç”Ÿ false sharing å¹²æ‰°ã€‚å› æ­¤ï¼Œå¤šä¸ª <code>rbItem</code>  æ— æ³•è¢«åŒæ—¶è½½å…¥ä¸€ä¸ª Cache Line ä¸­ï¼Œæ‰€ä»¥æ•°æ®ç«äº‰çš„é—®é¢˜ä¹ŸåŒæ—¶è¢«é¿å…äº†ã€‚å®æµ‹å‘¢ï¼Œå¥½åƒæœ‰ç‚¹ç‚¹æ”¹å–„ï¼Œä½†ä¹Ÿæ²¡æœ‰å¥½åˆ°ä¸€å€çš„çŠ¶æ€ï¼Œä¸è¿‡å³ä½¿æ²¡æœ‰æ€§èƒ½æ”¹å–„ï¼Œä¸ºäº† DATA RACE ä¹Ÿå¿…é¡»è¿›è¡Œè¿™æ ·çš„å¯¹é½ï¼Œæ‰èƒ½ç¡®ä¿åœ¨è¿™é‡Œä¸å¿…å¼•å…¥ä¸€é¢—é”ã€‚</p>
<p>åœ¨ <code>ringBuf</code> ä¸­åŒæ ·ä¹Ÿæœ‰å¯¹é½å­—æ®µä»¥å…æ“ä½œ head/tail/putWaits/getWaits æ—¶å…³è”è½½å…¥ data æŒ‡é’ˆï¼Œä¸è¿‡æ­£å› ä¸ºdataæ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥è¿™ä¸ªå¯¹é½å­—æ®µçš„æ•ˆç”¨é€šå¸¸ä¸º 0ã€‚ä¸ºäº†ä»£ç å¯ç§»æ¤æ€§ï¼ˆåˆ° C++11 æ¨¡ç‰ˆç±»ï¼Ÿï¼‰ï¼Œæš‚ä¸”ä¿ç•™è¯¥å¯¹é½ã€‚</p>
<h3 id="_2">æ“ä½œ<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<h4 id="_3">æµ‹è¯•ï¼šé˜Ÿåˆ—ç©ºï¼Œé˜Ÿåˆ—æ»¡<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">IsEmpty</span><span class="p">()</span> <span class="p">(</span><span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span> <span class="kt">uint32</span>
    <span class="kd">var</span> <span class="nx">quad</span> <span class="kt">uint64</span>
    <span class="nx">quad</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint64</span><span class="p">((</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)))</span>
    <span class="nx">head</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&amp;</span> <span class="nx">MaxUint32_64</span><span class="p">)</span>
    <span class="nx">tail</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
    <span class="c1">// var tail, head uint32</span>
    <span class="c1">// head = atomic.LoadUint32(&amp;rb.head)</span>
    <span class="c1">// tail = atomic.LoadUint32(&amp;rb.tail)</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="nx">head</span> <span class="o">==</span> <span class="nx">tail</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">IsFull</span><span class="p">()</span> <span class="p">(</span><span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span> <span class="kt">uint32</span>
    <span class="kd">var</span> <span class="nx">quad</span> <span class="kt">uint64</span>
    <span class="nx">quad</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint64</span><span class="p">((</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)))</span>
    <span class="nx">head</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&amp;</span> <span class="nx">MaxUint32_64</span><span class="p">)</span>
    <span class="nx">tail</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
    <span class="nx">b</span> <span class="p">=</span> <span class="p">((</span><span class="nx">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">capModMask</span><span class="p">)</span> <span class="o">==</span> <span class="nx">head</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></div>

<h5 id="headtail">å…³äº head/tail çš„è½½å…¥ä¼˜åŒ–<a class="headerlink" href="#headtail" title="Permanent link">&para;</a></h5>
<p>ç”±äºæˆ‘ä»¬é™å®šäº† head å’Œ tail æŒ‡é’ˆä¸º 32 ä½æ•´æ•°ï¼Œå› æ­¤åŸå­æ“ä½œå¯ä»¥ä¸€æ¬¡å–å¾—å®ƒä»¬è€Œä¸æ˜¯ä¸¤æ¬¡ã€‚è¿™èƒ½å¤Ÿå¸¦æ¥å°å°çš„æå‡ï¼Œå®æµ‹è¯æ˜äº†æœ‰å…¶å­˜åœ¨çš„ä»·å€¼ã€‚</p>
<blockquote>
<p>å¦‚æœ CPU æ¶æ„ä½¿ç”¨ Big Endian æ¨¡å¼ï¼Œä¸Šè¿°ä»£ç éœ€è¦è¢«è°ƒæ•´ã€‚</p>
<p>åœ¨ç§»æ¤æ—¶æ‰ä¼šè€ƒè™‘é’ˆå¯¹æ€§æ”¹å†™ã€‚</p>
<p><strong>è€ƒè™‘è¿›ä¸€æ­¥ä¼˜åŒ–</strong>ï¼š</p>
<p>å¦‚æœæ˜¯ C++/C/ASMçš„è¯ï¼ŒåŸå­æŒ‡ä»¤çš„ç›¸å…³å‡½æ•°è°ƒç”¨å¯ä»¥å»æ‰ï¼Œquardï¼Œtailï¼Œheadå¯ä»¥ä½¿ç”¨å¯„å­˜å™¨ï¼Œä¹Ÿæ— éœ€ AND å’Œ SHIFT è¿ç®—ã€‚</p>
<p>binary åŒ…å¯¹æ­¤æ²¡æœ‰å¸®åŠ©ã€‚</p>
</blockquote>
<h5 id="headtail_1">è¿›ä¸€æ­¥çš„é’ˆå¯¹ head/tail çš„ä¼˜åŒ–<a class="headerlink" href="#headtail_1" title="Permanent link">&para;</a></h5>
<p>ç”±äº put æ“ä½œä½¿ç”¨ tail å’Œ headï¼Œä½†ä¸ä¼šä¿®æ”¹ headï¼ˆç›¸åº”çš„ get æ“ä½œä¹Ÿç±»ä¼¼äºæ­¤ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æœ‰å¦ä¸€ä¸ªé€‰æ‹©è¿›è¡Œæ€§èƒ½æå‡ï¼š</p>
<p>åˆ†ç¦» head å’Œ tail çš„å­˜å‚¨ä½ç½®ä¿è¯ä¸ä¼šåŒæ—¶è½½å…¥å•ä¸€ CacheLineã€‚</p>
<p>è¿™ä¸ªç­–ç•¥å¯ä»¥è¿™æ ·å®ç°ï¼š</p>
<div class="highlight"><pre><span></span><code>    <span class="nx">ringBuf</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">cap</span>        <span class="kt">uint32</span>
        <span class="nx">capModMask</span> <span class="kt">uint32</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">head</span>       <span class="kt">uint32</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">tail</span>       <span class="kt">uint32</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">putWaits</span>   <span class="kt">uint64</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">getWaits</span>   <span class="kt">uint64</span>
        <span class="nx">_</span>          <span class="p">[</span><span class="nx">CacheLinePadSize</span> <span class="o">-</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
        <span class="nx">data</span>       <span class="p">[]</span><span class="nx">rbItem</span>
        <span class="nx">debugMode</span>  <span class="kt">bool</span>
        <span class="nx">logger</span>     <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="p">}</span>

<span class="c1">// æ­¤æ—¶éœ€è¦åˆ†åˆ«å–å¾— head tailï¼š</span>
<span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span> <span class="kt">uint32</span>
<span class="nx">head</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)</span>
<span class="nx">tail</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span>
</code></pre></div>

<p>è¿™ç§æ–¹æ³•åº”è¯¥æ¯”å½“å‰çš„ç®€è¦æ–¹æ¡ˆæ›´å…·æœ‰ä¼˜åŠ¿ã€‚ä½†æ˜¯å‡ºäºè¯•éªŒçš„ç›®çš„ï¼Œæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰åº”ç”¨è¯¥æ–¹æ¡ˆï¼Œè€Œæ˜¯å°†æ­¤ä¼˜åŒ–æ¨è¿Ÿåˆ° v1.x å‘å¸ƒæ—¶ã€‚ç›®å‰ go-ringbuf v0.7.x å°†é‡‡ç”¨å‰æ–‡è¿°åŠåˆ°å•æ¬¡åŸå­æ“ä½œæ–¹æ¡ˆã€‚</p>
<h5 id="_4">å…³äºåˆ¤å®šç®—æ³•<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h5>
<p>æˆ‘ä»¬é‡‡ç”¨æ ‡å‡†çš„ç¯å½¢é˜Ÿåˆ—å®ç°æ–¹æ¡ˆï¼š</p>
<ol>
<li>ä¿ç•™ä¸€ä¸ªå…ƒç´ çš„ç©ºé—´</li>
</ol>
<p>å³ä¸å…è®¸ tail èµ¶ä¸Š headï¼Œé˜Ÿå°¾èŠ‚ç‚¹å’Œå¯¹é¦–èŠ‚ç‚¹ä¹‹é—´è‡³å°‘ç•™æœ‰ä¸€ä¸ªå…ƒç´ çš„ç©ºé—´ã€‚</p>
<p>å¦‚æœ head == tailï¼Œé˜Ÿåˆ—ç©ºï¼›</p>
<p>å¦‚æœ (tail+1) % M == headï¼Œé˜Ÿåˆ—æ»¡ã€‚</p>
<h4 id="cap-size">Cap å’Œ Size<a class="headerlink" href="#cap-size" title="Permanent link">&para;</a></h4>
<p><code>Cap()</code> è¡¨ç¤ºç¯å½¢é˜Ÿåˆ—çš„å®¹é‡ï¼Œ<code>Size()</code> åŠå…¶åŒä¹‰è¯ <code>Quantity()</code> è¿”å›çš„æ˜¯å½“å‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">Quantity</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">Size</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">Size</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">quantity</span> <span class="kt">uint32</span>
    <span class="c1">// head = atomic.LoadUint32(&amp;rb.head)</span>
    <span class="c1">// tail = atomic.LoadUint32(&amp;rb.tail)</span>
    <span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span> <span class="kt">uint32</span>
    <span class="kd">var</span> <span class="nx">quad</span> <span class="kt">uint64</span>
    <span class="nx">quad</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint64</span><span class="p">((</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)))</span>
    <span class="nx">head</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&amp;</span> <span class="nx">MaxUint32_64</span><span class="p">)</span>
    <span class="nx">tail</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">tail</span> <span class="o">&gt;=</span> <span class="nx">head</span> <span class="p">{</span>
        <span class="nx">quantity</span> <span class="p">=</span> <span class="nx">tail</span> <span class="o">-</span> <span class="nx">head</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">quantity</span> <span class="p">=</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">capModMask</span> <span class="o">+</span> <span class="p">(</span><span class="nx">tail</span> <span class="o">-</span> <span class="nx">head</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">quantity</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">Cap</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">cap</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="enqueue-put">Enqueue / Put<a class="headerlink" href="#enqueue-put" title="Permanent link">&para;</a></h4>
<p>ä¸€äº›æ— é”æ–¹æ¡ˆåœ¨å®ç°ä¹‹åä¼šæ˜¾å¾—è¾ƒä¸ºç„å¦™ï¼Œè¿™å½“ç„¶æ˜¯ä½“ç°äº†è®¾è®¡è€…çš„ç²¾å·§æ€è·¯çš„ã€‚å…¶éº»çƒ¦åœ¨äºï¼Œé…å›¾é…è®ºæ–‡éƒ½ä¸å®¹æ˜“æ”¹å–„å®ƒä»¬çš„å¯è¯»æ€§ã€‚</p>
<h5 id="put">Put ç®—æ³•<a class="headerlink" href="#put" title="Permanent link">&para;</a></h5>
<p>åœ¨æˆ‘ä»¬çš„ <code>ringBuf</code> ä¸­ï¼Œè§£å†³æ— é”ä»¥åŠé¿è®©é—®é¢˜é‡‡ç”¨äº†æ¯”è¾ƒæ˜æ™°è€Œä¸”ç®€æ´çš„è·¯å­ï¼Œå…¶æ€è·¯æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>
<p>æ¯ä¸ª <code>rbItem</code> æ‰¿è½½ç€ä¸€ä¸ªæ ‡å¿— <code>readWrite</code> ä»¥åŠå…ƒç´ å®ä½“ <code>value</code></p>
</li>
<li>
<p>ç”³è¯·é˜Ÿå°¾å†™å…¥æƒ</p>
</li>
</ol>
<p>å½“å…¥é˜Ÿåˆ—æ“ä½œæ—¶ï¼Œé¦–å…ˆæœŸå¾… <code>readWrite</code> == 0ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªé˜Ÿåˆ—å°¾éƒ¨çš„ <code>rbItem</code> æ˜¯å¹²å‡€çš„ï¼Œå†™å…¥å°±ç»ªçš„ï¼ˆå³ç©ºé—²çŠ¶æ€ï¼‰ï¼›</p>
<p>ä¸€æ—¦åŸå­æ“ä½œç¡®è®¤åˆ°è¿™æ ·çš„é˜Ÿåˆ—å°¾éƒ¨ <code>rbItem</code>ï¼Œåˆ™å…¶ <code>readWrite</code> æ ‡å¿—ä¹Ÿè¢«æ›´æ–°ä¸º 2ã€‚è¿™è¡¨ç¤ºç€è¯¥ <code>rbItem</code> è¢«ç”³è¯·æˆåŠŸäº†ã€‚å…¶å®ƒ producers å°†æ— æ³•å–å¾—è¯¥ <code>rbItem</code> ä½œä¸ºå®ƒä»¬çš„å†™å…¥ç›®æ ‡äº†ã€‚</p>
<ol>
<li>
<p>ç°åœ¨æ˜¯æ—¶å€™æ›´æ–° <code>tail</code> æŒ‡é’ˆåˆ°ä¸‹ä¸€å…ƒç´ äº†</p>
</li>
<li>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°æ›´æ–° <code>value</code> æˆå‘˜ï¼ˆå¤šä¸ª <code>rbItem</code>  æ— æ³•è¢«åŒæ—¶è½½å…¥ä¸€ä¸ª Cache Line ä¸­ï¼‰</p>
</li>
<li>
<p>æœ€åï¼Œæˆ‘ä»¬å°† <code>readWrite</code> æ ‡å¿—æ›´æ–°ä¸º <code>1</code>ï¼Œè¿™æ ‡å¿—ç€å…¥åˆ—æ“ä½œå·²ç»å®Œæˆï¼Œè¿™ä¸ª <code>rbItem</code> ç°åœ¨æ˜¯è¯»å‡ºå°±ç»ªçš„</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">Enqueue</span><span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">nt</span> <span class="kt">uint32</span>
    <span class="kd">var</span> <span class="nx">holder</span> <span class="o">*</span><span class="nx">rbItem</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">quad</span> <span class="kt">uint64</span>
        <span class="nx">quad</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint64</span><span class="p">((</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)))</span>
        <span class="nx">head</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&amp;</span> <span class="nx">MaxUint32_64</span><span class="p">)</span>
        <span class="nx">tail</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
        <span class="c1">// head = atomic.LoadUint32(&amp;rb.head)</span>
        <span class="c1">// tail = atomic.LoadUint32(&amp;rb.tail)</span>
        <span class="nx">nt</span> <span class="p">=</span> <span class="p">(</span><span class="nx">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">capModMask</span>

        <span class="nx">isFull</span> <span class="o">:=</span> <span class="nx">nt</span> <span class="o">==</span> <span class="nx">head</span>
        <span class="k">if</span> <span class="nx">isFull</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrQueueFull</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">holder</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">tail</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">holder</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">item</span>
            <span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">tail</span><span class="p">,</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">nt</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="p">}</span>

        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Nanosecond</span><span class="p">)</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">putWaits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;[W] %w, 2=&gt;1, %v&quot;</span><span class="p">,</span> <span class="nx">ErrRaced</span><span class="p">,</span> <span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">return</span>
<span class="p">}</span>
</code></pre></div>

<h5 id="_5">ä¾‹å¤–æƒ…å†µ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h5>
<ol>
<li>
<p><code>æ­¥éª¤2</code> æ“ä½œå¤±è´¥æ—¶ï¼Œæ„å‘³ç€å…¶å®ƒ producers å·²ç»æ‹¿åˆ°äº†é˜Ÿå°¾ <code>rbItem</code> çš„å†™å…¥æƒï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª 1ns çš„å»¶è¿Ÿå¹¶å†æ¬¡è‡ªæ—‹ï¼Œä»¥æ±‚å–å¾—æ–°çš„é˜Ÿå°¾å†™å…¥æƒã€‚</p>
</li>
<li>
<p><code>æ­¥éª¤3</code> çš„åŸå­æ“ä½œå¯èƒ½ä¼šå¤±è´¥ã€‚</p>
</li>
</ol>
<p>è¿™ä»£è¡¨ç€è¿™ä¸ªé˜Ÿå°¾å·²ç»æ—§äº†ï¼Œæ–°çš„é˜Ÿå°¾å·²ç»è¢«åˆ«çš„ producers æäº¤æˆåŠŸäº†ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å¿½ç•¥ <code>tail</code> çš„æ›´æ–°ä¸æˆåŠŸçš„é—®é¢˜ã€‚</p>
<ol>
<li><code>æ­¥éª¤4</code> å­˜åœ¨å¶ç„¶çš„å¯èƒ½æ€§ä¼šå¤±è´¥ã€‚</li>
</ol>
<p>è¿™ç§å¯èƒ½æ€§å‘ç”Ÿæ—¶ï¼Œä»£è¡¨ç€è¿è¡Œç¯å¢ƒå·²ç»å´©å¡Œäº†ï¼Œå±äºè‡´å‘½æ€§é”™è¯¯ã€‚</p>
<p>æš‚æ—¶ï¼Œæˆ‘ä¸èƒ½æ’é™¤æ—¶ç®—æ³•é”™è¯¯çš„å› ç´ å¸¦æ¥çš„è¿™ä¸ªé”™è¯¯ï¼Œä½†ç›®å‰ç»è¿‡å¤§é‡å·¥ç¨‹å®æµ‹éªŒè¯æ¥çœ‹ï¼Œç®—æ³•å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„ï¼Œä½†æ²¡æœ‰ç¼ºé™·ã€‚</p>
<p>ç†è®ºä¸Šçš„è¯æ˜éœ€è¦å¦å¤–æˆæ–‡äº†ï¼Œä»¥åå†è¯´äº†ã€‚</p>
<h4 id="dequeue-get">Dequeue / Get<a class="headerlink" href="#dequeue-get" title="Permanent link">&para;</a></h4>
<h5 id="get">Getç®—æ³•<a class="headerlink" href="#get" title="Permanent link">&para;</a></h5>
<p>ç±»ä¼¼äº Put ç®—æ³•ï¼ŒGet ç®—æ³•æ“ä½œ head æŒ‡é’ˆå¹¶å†™å…¥ value å®ä½“ï¼š</p>
<ol>
<li>
<p>æ¯ä¸ª <code>rbItem</code> æ‰¿è½½ç€ä¸€ä¸ªæ ‡å¿— <code>readWrite</code> ä»¥åŠå…ƒç´ å®ä½“ <code>value</code></p>
</li>
<li>
<p>ç”³è¯·é˜Ÿé¦–è¯»å–å’Œæ›´æ–°æƒ</p>
</li>
</ol>
<p>å½“å‡ºé˜Ÿåˆ—æ“ä½œæ—¶ï¼Œé¦–å…ˆæœŸå¾… <code>readWrite</code> == 1ï¼Œè¿™æ„å‘³ç€è¿™ä¸ªé˜Ÿåˆ—å°¾éƒ¨çš„ <code>rbItem</code> æ˜¯å¹²å‡€çš„ï¼Œè¯»å‡ºå°±ç»ªçš„ï¼›</p>
<p>ä¸€æ—¦åŸå­æ“ä½œç¡®è®¤åˆ°è¿™æ ·çš„é˜Ÿåˆ—å°¾éƒ¨ <code>rbItem</code>ï¼Œåˆ™å…¶ <code>readWrite</code> æ ‡å¿—ä¹Ÿè¢«æ›´æ–°ä¸º 3ã€‚è¿™è¡¨ç¤ºç€è¯¥ <code>rbItem</code> è¢«ç”³è¯·æˆåŠŸäº†ã€‚å…¶å®ƒ consumers å°†æ— æ³•å–å¾—è¯¥ <code>rbItem</code> ä½œä¸ºå®ƒä»¬çš„è¯»å‡ºç›®æ ‡äº†ã€‚</p>
<ol>
<li>
<p>ç°åœ¨æ˜¯æ—¶å€™æ›´æ–° <code>head</code> æŒ‡é’ˆåˆ°ä¸‹ä¸€å…ƒç´ äº†</p>
</li>
<li>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è¯»å– <code>value</code> æˆå‘˜ï¼ˆå¤šä¸ª <code>rbItem</code>  æ— æ³•è¢«åŒæ—¶è½½å…¥ä¸€ä¸ª Cache Line ä¸­ï¼‰</p>
</li>
<li>
<p>æœ€åï¼Œæˆ‘ä»¬å°† <code>readWrite</code> æ ‡å¿—æ›´æ–°ä¸º <code>0</code>ï¼Œè¿™æ ‡å¿—ç€å‡ºåˆ—æ“ä½œå·²ç»å®Œæˆï¼Œè¿™ä¸ª <code>rbItem</code> ç°åœ¨æ˜¯ç©ºé—²çŠ¶æ€äº†ã€‚</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="p">(</span><span class="nx">rb</span> <span class="o">*</span><span class="nx">ringBuf</span><span class="p">)</span> <span class="nx">Dequeue</span><span class="p">()</span> <span class="p">(</span><span class="nx">item</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">nh</span> <span class="kt">uint32</span>
    <span class="kd">var</span> <span class="nx">holder</span> <span class="o">*</span><span class="nx">rbItem</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">quad</span> <span class="kt">uint64</span>
        <span class="nx">quad</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">LoadUint64</span><span class="p">((</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">)))</span>
        <span class="nx">head</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&amp;</span> <span class="nx">MaxUint32_64</span><span class="p">)</span>
        <span class="nx">tail</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">quad</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>
        <span class="c1">// head = atomic.LoadUint32(&amp;rb.head)</span>
        <span class="c1">// tail = atomic.LoadUint32(&amp;rb.tail)</span>

        <span class="nx">isEmpty</span> <span class="o">:=</span> <span class="nx">head</span> <span class="o">==</span> <span class="nx">tail</span>
        <span class="k">if</span> <span class="nx">isEmpty</span> <span class="p">{</span>
            <span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrQueueEmpty</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">holder</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">head</span><span class="p">]</span>

        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">item</span> <span class="p">=</span> <span class="nx">holder</span><span class="p">.</span><span class="nx">value</span>
            <span class="nx">nh</span> <span class="p">=</span> <span class="p">(</span><span class="nx">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">capModMask</span>
            <span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">head</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">nh</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="p">}</span>

        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Nanosecond</span><span class="p">)</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rb</span><span class="p">.</span><span class="nx">getWaits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nx">CompareAndSwapUint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;[R] %w, 3=&gt;0, %v&quot;</span><span class="p">,</span> <span class="nx">ErrRaced</span><span class="p">,</span> <span class="nx">holder</span><span class="p">.</span><span class="nx">readWrite</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;[ringbuf][GET] cap: %v, qty: %v, head: %v, tail: %v, new head: %v&quot;</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">cap</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">qty</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">tail</span><span class="p">),</span> <span class="nx">head</span><span class="p">,</span> <span class="nx">tail</span><span class="p">,</span> <span class="nx">nh</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">!</span><span class="nx">rb</span><span class="p">.</span><span class="nx">debugMode</span> <span class="p">{</span>
            <span class="nx">rb</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Warn</span><span class="p">(</span><span class="s">&quot;[ringbuf][GET] &quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="s">&quot;cap&quot;</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">cap</span><span class="p">),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="s">&quot;qty&quot;</span><span class="p">,</span> <span class="nx">rb</span><span class="p">.</span><span class="nx">qty</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">tail</span><span class="p">)),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="s">&quot;tail&quot;</span><span class="p">,</span> <span class="nx">tail</span><span class="p">),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">,</span> <span class="nx">head</span><span class="p">),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">(</span><span class="s">&quot;new head&quot;</span><span class="p">,</span> <span class="nx">nh</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="nx">rb</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;[ringbuf][GET] [ERR] unexpected nil element value FOUND!&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></div>

<p>åŒæ ·åœ°ï¼Œå¤šä¸ª consumers é€šè¿‡ 1ns çš„è‡ªæ—‹æ¥ç”³è¯·è¯»å‡ºæƒç›´è‡³æˆåŠŸï¼Œè¿™ä¼šå¸¦æ¥æ½œåœ¨çš„é˜»å¡é—®é¢˜ã€‚</p>
<p>æ—¢ç„¶ <code>ringBuf</code> çš„ç”¨é€”æ—¶é¢å‘é«˜ååã€é«˜å¹¶å‘åœºæ™¯ï¼Œé‚£ä¹ˆå¤šä¸ª consumers åœ¨ç”³è¯·è¯»å‡ºæƒå¤±è´¥æ—¶è¢«é˜»å¡ä¹Ÿæ˜¯è°ƒç”¨è€…æœŸå¾…çš„è¡Œä¸ºï¼Œå› ä¸ºé‚£ä¸ªæˆåŠŸçš„ consumer å¿…ç„¶ä¼šåœ¨æœ‰é™çš„æ­¥éª¤é‡Œï¼ˆä¸€èˆ¬æ¥è¯´å¯èƒ½æ˜¯ 2.691Âµs è¿™ä¸ªçº§åˆ«ï¼‰é‡Šæ”¾è¿™ä¸ªè¢«é”å®šçš„å…ƒç´ ï¼Œæ‰€ä»¥å¾€å¾€è‡ªæ—‹ 1 åˆ°æ•°æ¬¡å³å¯æ‹¿åˆ°ä¸‹ä¸€ä¸ªæ–°çš„é˜Ÿé¦–å…ƒç´ çš„è¯»å‡ºæƒã€æˆ–è€…æ˜¯è¿”å›é˜Ÿåˆ—ä¸ºç©ºé”™è¯¯ç”±è°ƒç”¨è€…å†³å®šä¸‹ä¸€æ­¥è¡Œä¸ºã€‚</p>
<p>æ³¨æ„ Enqueue åœ¨ç›¸ä¼¼çš„æ­¥éª¤ä¸­é¢å¯¹çš„æƒ…å†µæ˜¯ç±»ä¼¼çš„ï¼Œå› è€Œä¸å†å•ç‹¬è§£æå…¶è¡Œä¸ºã€‚</p>
<p>ç”±äºè‡ªæ—‹éƒ¨åˆ†ä¸€å®šä¼šåœ¨æœ‰é™æ­¥éª¤ä¸­é€€å‡ºï¼ˆæˆåŠŸï¼Œå¤±è´¥ï¼Œç©ºé˜Ÿåˆ—ï¼‰ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†ç®—æ³•æ˜¯ lock free çš„ã€‚</p>
<h3 id="_6">å°ç»“<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>æˆ‘ä»¬å·²ç»è§£é‡Šäº†å…³é”®æ€§çš„æ— é” Enqueue/Dequeue æ€è·¯ï¼Œå…·ä½“çš„å®ç°ä»£ç åœ¨ <a href="https://github.com/hedzr/go-ringbuf">https://github.com/hedzr/go-ringbuf</a> ä¸­å¯ä»¥æ‰¾åˆ°ã€‚</p>
<h4 id="_7">æ€§èƒ½<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<h5 id="mpmc">MPMC<a class="headerlink" href="#mpmc" title="Permanent link">&para;</a></h5>
<p>æˆ‘ä»¬åœ¨å®ç°è¿‡ç¨‹ä¸­ä½œå‡ºäº†å¿…è¦çš„å–èˆï¼Œç›®å‰çœ‹æ¥ç®—æ³•æ­£ç¡®æ€§æ˜¯æœ‰ä¿éšœçš„ã€‚åŒæ—¶å®ƒçš„æ€§èƒ½ä¸ä¿—ï¼š</p>
<div class="highlight"><pre><span></span><code>$ go <span class="nb">test</span> ./ringbuf/rb -v -race -run <span class="s1">&#39;TestRingBuf_MPut&#39;</span>
<span class="o">===</span> RUN   TestRingBuf_MPut
    TestRingBuf_MPut: rb_test.go:223: Grp: <span class="m">16</span>, Times: <span class="m">1360000</span>, use: <span class="m">26</span>.266041367s, <span class="m">19</span>.313Âµs/op
    TestRingBuf_MPut: rb_test.go:224: Put: <span class="m">1360000</span>, use: <span class="m">24</span>.036637261s, <span class="m">17</span>.673Âµs/op <span class="p">|</span> retry times: <span class="m">0</span>
    TestRingBuf_MPut: rb_test.go:225: Get: <span class="m">1360000</span>, use: <span class="m">2</span>.229404106s, <span class="m">1</span>.639Âµs/op <span class="p">|</span> retry times: <span class="m">0</span>
--- PASS: TestRingBuf_MPut <span class="o">(</span><span class="m">51</span>.29s<span class="o">)</span>

<span class="o">===</span> RUN   TestRingBuf_MPut
    TestRingBuf_MPut: rb_test.go:231: Grp: <span class="m">16</span>, Times: <span class="m">1360000</span>, use: <span class="m">42</span>.836537705s, <span class="m">31</span>.497Âµs/op
    TestRingBuf_MPut: rb_test.go:232: Put: <span class="m">1360000</span>, use: <span class="m">39</span>.277276612s, <span class="m">28</span>.88Âµs/op <span class="p">|</span> retry times: <span class="m">0</span>
    TestRingBuf_MPut: rb_test.go:233: Get: <span class="m">1360000</span>, use: <span class="m">3</span>.559261093s, <span class="m">2</span>.617Âµs/op <span class="p">|</span> retry times: <span class="m">0</span>
--- PASS: TestRingBuf_MPut <span class="o">(</span><span class="m">53</span>.60s<span class="o">)</span>
</code></pre></div>

<p>æˆ‘ä»¬è¿è¡Œå¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…çš„æ‰‹å·¥ benchmark æµ‹è¯•å¯ä»¥å¾—åˆ°ä»¥ä¸Šç»“æœï¼Œè¿™é‡Œç»™å‡ºçš„ç»“æœå®ä¾‹æ˜¯ä¸¤æ¬¡è¿è¡Œçš„ç»“æœï¼ŒåŸå› æ˜¯å•ç‹¬çš„å·¥ä½œç«™æµ‹è¯•çš„å‚è€ƒä»·å€¼ä¸€èˆ¬è¯ä¸”ä¸ç¨³å®šã€‚ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ° put + get çš„æ“ä½œå¹³å‡å€¼å¤§çº¦åœ¨ 19.313Âµs/op .. 31.497Âµs/op ä¹‹é—´ã€‚</p>
<p>ç”±äºæ¨¡æ‹Ÿäº†çœŸå®åœºæ™¯çš„æ¶ˆè´¹æƒ…å†µï¼Œå› æ­¤è¦†ç›–äº† Enqueue/Dequeue çš„å„ä¸ªåˆ†æ”¯å°¤å…¶æ˜¯åšåˆ°äº†ç”³è¯·å†™å…¥/è¯»å‡ºæƒç«äº‰çŠ¶æ€çš„æ¨¡æ‹Ÿï¼Œå› æ­¤è¿™é‡Œçš„æ•°æ®æ¯”è¾ƒæœ‰å‚è€ƒä»·å€¼ã€‚</p>
<p>1.639Âµs/op çš„å‡ºåˆ—ï¼ˆ610M/sï¼‰ï¼Œ17.673Âµs/op çš„å…¥åˆ—ï¼ˆ57M/sï¼‰å·²ç»æ˜¯è¾¾åˆ°äº†æˆ‘ä»¬é¢„æœŸçš„ç›®æ ‡äº†ã€‚</p>
<h5 id="_8">å¯¹ç…§<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h5>
<p>ä¸ºäº†æ¨ªå‘æ¯”è¾ƒï¼Œæˆ‘ä»¬ä»¥ç›¸åŒæ–¹å¼è¿è¡Œäº†åˆ«çš„ä¾‹å­ï¼Œå¾—åˆ°çš„ç»“è®ºæ˜¯ ringBuf å¤§æ¦‚åœ¨ 9.734Âµs/op å·¦å³ï¼Œè€Œå¯¹ç…§è€…å¤§çº¦åœ¨ 8.373Âµs/op å·¦å³ã€‚</p>
<p>ä¹‹æ‰€ä»¥è¿™ç»„å¯¹ç…§ç»“æœå’Œ MPMC æœ‰æ‰€ä¸åŒï¼ŒåŸå› æ˜¯å¯¹ç…§ç»„é‡‡ç”¨å…ˆä¸€æ¬¡æ€§å†™å…¥ç„¶åä¸€æ¬¡æ€§è¯»å‡ºçš„æ–¹å¼æ¥è®¡ç®— put+get æ—¶é•¿ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨åŒæ ·çš„æµ‹è¯•æ–¹å¼å¦è¡Œå®Œæˆäº†å¯¹ç…§æµ‹è¯•ã€‚</p>
<p>åœ¨é«˜æ€§èƒ½æœåŠ¡å™¨ä¸Šï¼Œå·¥ä½œæ€§èƒ½æœ‰å¯èƒ½è¾¾åˆ° 1~2Âµs/op çº§åˆ«ï¼ˆå¢åŠ æ ¸å¿ƒã€å¢åŠ å†…å­˜ï¼Œé€‰æ‹©é«˜æ€»çº¿å¸¦å®½ï¼‰ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">===</span> RUN   TestQueuePutGetLong
    TestQueuePutGetLong: rb_test.go:399: Grp: <span class="m">64</span>, Times: <span class="m">20800000</span>, use: 2m1.90187948s, <span class="m">5</span>.86Âµs/op
    TestQueuePutGetLong: rb_test.go:400: Put: <span class="m">20800000</span>, use: <span class="m">52</span>.716325629s, <span class="m">2</span>.534Âµs/op
    TestQueuePutGetLong: rb_test.go:401: Get: <span class="m">20800000</span>, use: <span class="m">57</span>.048982796s, <span class="m">2</span>.742Âµs/op
--- PASS: TestQueuePutGetLong <span class="o">(</span><span class="m">121</span>.90s<span class="o">)</span>
</code></pre></div>

<h5 id="_9">è¯´æ˜<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h5>
<p>æ€§èƒ½æµ‹è¯•è‡ªå·±è·‘æ‰èƒ½æ¯”è¾ƒï¼Œå› ä¸ºæˆ‘æ‡’å¾—å»æ‰¾æ ‡å‡†æœºåš Benchmarkã€‚ä¸Šé¢ç»™å‡ºçš„æ•°æ®æ˜¯åœ¨ i5-5257U CPU @ 2.70GHz çš„ MBP ä¸Šè·‘å‡ºæ¥çš„ï¼Œåªèƒ½è¯æ˜ Server ç«¯è¡¨ç°å¯ä»¥æ›´å¥½ï¼Œä½†ä¸èƒ½å½“ä½œç‹¬ç«‹çš„ä¾æ®ã€‚</p>
<h2 id="_10">ğŸ”š<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><a href="https://zh.wikipedia.org/wiki/%E7%92%B0%E5%BD%A2%E7%B7%A9%E8%A1%9D%E5%8D%80">ç’°å½¢ç·©è¡å€ - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦</a>&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><a href="http://wiki.c2.com/?CircularBuffer">http://wiki.c2.com/?CircularBuffer</a>&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><a href="https://www.boost.org/doc/libs/1_39_0/libs/circular_buffer/doc/circular_buffer.html">https://www.boost.org/doc/libs/1_39_0/libs/circular_buffer/doc/circular_buffer.html</a>&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>å¤šæ ¸ CPUï¼ŒCPUé›†ç¾¤ï¼šé¢„å–ï¼Œä¹±åºæ‰§è¡Œï¼Œè¶…æ ‡é‡æµæ°´çº¿ï¼Œå¹¶å‘ç¼–ç¨‹&#160;<a class="footnote-backref" href="#fnref:4" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>Paul E. McKenney: <a href="http://www.rdrop.com/users/paulmck/scalability/paper/whymb.2010.06.07c.pdf"><em>Memory Barriers: a Hardware View for Software Hackers</em></a>&#160;<a class="footnote-backref" href="#fnref:5" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>å†…å­˜å±éšœ (Wikipedia): <a href="https://en.wikipedia.org/wiki/Memory_barrier">https://en.wikipedia.org/wiki/Memory_barrier</a>&#160;<a class="footnote-backref" href="#fnref:6" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
<li id="fn:7">
<p>IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual, <a href="https://software.intel.com/en-us/articles/intel-sdm">https://software.intel.com/en-us/articles/intel-sdm</a>&#160;<a class="footnote-backref" href="#fnref:7" title="Jump back to footnote 7 in the text">&#8617;</a></p>
</li>
<li id="fn:8">
<p>Memory Barriers/Fences, <a href="https://mechanical-sympathy.blogspot.jp/2011/07/memory-barriersfences.html">https://mechanical-sympathy.blogspot.jp/2011/07/memory-barriersfences.html</a>&#160;<a class="footnote-backref" href="#fnref:8" title="Jump back to footnote 8 in the text">&#8617;</a></p>
</li>
<li id="fn:9">
<p>Memory Barriers: a Hardware View for Software Hackers, Paul E. McKenney, Linux Technology Center, IBM Beaverton, <a href="https://www.researchgate.net/publication/228824849_Memory_Barriers_a_Hardware_View_for_Software_Hackers">https://www.researchgate.net/publication/228824849_Memory_Barriers_a_Hardware_View_for_Software_Hackers</a>&#160;<a class="footnote-backref" href="#fnref:9" title="Jump back to footnote 9 in the text">&#8617;</a></p>
</li>
<li id="fn:10">
<p>Intel Sandy Bridge Configuration, <a href="http://www.7-cpu.com/cpu/SandyBridge.html">http://www.7-cpu.com/cpu/SandyBridge.html</a>&#160;<a class="footnote-backref" href="#fnref:10" title="Jump back to footnote 10 in the text">&#8617;</a></p>
</li>
<li id="fn:11">
<p>Intelâ€™s Haswell CPU Microarchitecture, <a href="http://www.realworldtech.com/haswell-cpu/5/">http://www.realworldtech.com/haswell-cpu/5/</a>&#160;<a class="footnote-backref" href="#fnref:11" title="Jump back to footnote 11 in the text">&#8617;</a></p>
</li>
<li id="fn:12">
<p>Write Combining, <a href="http://mechanical-sympathy.blogspot.com/2011/07/write-combining.html">http://mechanical-sympathy.blogspot.com/2011/07/write-combining.html</a>&#160;<a class="footnote-backref" href="#fnref:12" title="Jump back to footnote 12 in the text">&#8617;</a></p>
</li>
<li id="fn:13">
<p>Memory ordering, <a href="https://en.wikipedia.org/wiki/Memory_ordering">https://en.wikipedia.org/wiki/Memory_ordering</a>&#160;<a class="footnote-backref" href="#fnref:13" title="Jump back to footnote 13 in the text">&#8617;</a></p>
</li>
<li id="fn:14">
<p><a href="http://lday.me/2017/12/02/0018_cpp_atomic_summary/">C++å†…å­˜å±éšœï¼ˆå†…å­˜é¡ºåºï¼‰æ€»ç»“</a>&#160;<a class="footnote-backref" href="#fnref:14" title="Jump back to footnote 14 in the text">&#8617;</a></p>
</li>
<li id="fn:15">
<p><a href="https://holajiawei.com/race-and-memory/">Race Condition(ç«æ€æ¡ä»¶) å’ŒMemory Barrier(å†…å­˜å±éšœ)</a>&#160;<a class="footnote-backref" href="#fnref:15" title="Jump back to footnote 15 in the text">&#8617;</a></p>
</li>
<li id="fn:16">
<p><a href="https://tonybai.com/2020/03/10/visualizing-memory-management-in-golang/">å¯è§†åŒ–Goå†…å­˜ç®¡ç†| Tony Bai</a>&#160;<a class="footnote-backref" href="#fnref:16" title="Jump back to footnote 16 in the text">&#8617;</a></p>
</li>
<li id="fn:100">
<p><a href="https://spcl.inf.ethz.ch/Teaching/2017-dphpc/recitation/seqcons.pdf">DPHPC: Sequential Consistency - pdf/slider</a>&#160;<a class="footnote-backref" href="#fnref:100" title="Jump back to footnote 17 in the text">&#8617;</a></p>
</li>
<li id="fn:101">
<p><a href="https://biz.51cto.com/art/201901/590602.htm">CPU Cache Lineä¼ªå…±äº«é—®é¢˜çš„æ€»ç»“å’Œåˆ†æ- 51CTO.COM</a>&#160;<a class="footnote-backref" href="#fnref:101" title="Jump back to footnote 18 in the text">&#8617;</a></p>
</li>
<li id="fn:201">
<p><a href="https://wweir.cc/post/æ¢ç´¢-golang-ä¸€è‡´æ€§åŸè¯­/"><strong>æ¢ç´¢Golang ä¸€è‡´æ€§åŸè¯­</strong>- æ¸©ä¹ æ±Ÿæ¹–</a>&#160;<a class="footnote-backref" href="#fnref:201" title="Jump back to footnote 19 in the text">&#8617;</a></p>
</li>
<li id="fn:202">
<p><a href="https://golang.org/ref/mem">https://golang.org/ref/mem</a>&#160;<a class="footnote-backref" href="#fnref:202" title="Jump back to footnote 20 in the text">&#8617;</a></p>
</li>
<li id="fn:203">
<p><a href="https://github.com/golang/go/wiki/LearnConcurrency">LearnConcurrency</a>: Read <a href="https://encore.dev/blog/advanced-go-concurrency">Advanced Go Concurrency Primitives</a>, Study <a href="https://golang.org/ref/mem">The Go Memory Model</a>&#160;<a class="footnote-backref" href="#fnref:203" title="Jump back to footnote 21 in the text">&#8617;</a></p>
</li>
<li id="fn:204">
<p><a href="http://longlog.me/2018/09/12/2018-09-12-golang-mem/">Golangå†…å­˜æ¨¡å‹| apeipoçš„åšå®¢</a>&#160;<a class="footnote-backref" href="#fnref:204" title="Jump back to footnote 22 in the text">&#8617;</a></p>
</li>
<li id="fn:205">
<p><a href="http://hugozhu.myalert.info/2013/04/20/31-golang-memory-model.html">Goè¯­è¨€å†…å­˜æ¨¡å‹</a>&#160;<a class="footnote-backref" href="#fnref:205" title="Jump back to footnote 23 in the text">&#8617;</a></p>
</li>
<li id="fn:206">
<p><a href="https://www.jianshu.com/p/ba9114542bb7">Golangå†…å­˜æ¨¡å‹- ç®€ä¹¦</a>&#160;<a class="footnote-backref" href="#fnref:206" title="Jump back to footnote 24 in the text">&#8617;</a></p>
</li>
<li id="fn:207">
<p><a href="https://github.com/xitu/gold-miner/blob/master/TODO/concurrent-programming.md">Goå¹¶å‘ç¼–ç¨‹ä¸­çš„é‚£äº›äº‹</a>&#160;<a class="footnote-backref" href="#fnref:207" title="Jump back to footnote 25 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="">
        
          <a href="../03.smp/" title="å¹¶å‘ç¼–ç¨‹å’Œå¤šæ ¸ç¼–ç¨‹æ¦‚è¦" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" /></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  ä¸Šä¸€é¡µ
                </span>
                å¹¶å‘ç¼–ç¨‹å’Œå¤šæ ¸ç¼–ç¨‹æ¦‚è¦
              </div>
            </div>
          </a>
        
        
          <a href="../../../about/" title="About" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  ä¸‹ä¸€é¡µ
                </span>
                About
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z" /></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 - 2020 Hedzr Yeh<br/><div style="margin: 12px 0"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯ã€‚</div>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.36cbf620.min.js"></script>
      <script src="../../../assets/javascripts/bundle.00c583dd.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "", "search.config.separator": "[\\uff0c\\u3002]+", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.7f7c8775.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../../statics/javascripts/extra.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>